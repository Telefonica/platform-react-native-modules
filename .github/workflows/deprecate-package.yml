name: ⚠️ Deprecate package version

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Public package (packages/public/*)"
        required: true
        type: choice
        options:
          - ios-common-cookies
      range:
        description: "Version or range (e.g. 1.0.1 or <1.0.2)"
        required: true
      message:
        description: "Deprecation message (e.g. 'Bad build, use >=1.0.2')"
        required: true

jobs:
  deprecate:
    name: Deprecate
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.FLOW_GITHUB_TOKEN }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable --immutable-cache

      - name: Set npm token
        uses: "./.github/actions/set-npm-token"
        with:
          npm-token: ${{ secrets.NPM_PUBLISH_TOKEN }}

      - name: Deprecate npm package version/range
        env:
          NPM_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
        run: |
          PKG_JSON="packages/public/${{ github.event.inputs.package }}/package.json"
          PKG_NAME=$(node -p "require(process.argv[1]).name" "$PKG_JSON")
          echo "Deprecating $PKG_NAME@${{ github.event.inputs.range }}"
          npm deprecate "$PKG_NAME@${{ github.event.inputs.range }}" "${{ github.event.inputs.message }}"
