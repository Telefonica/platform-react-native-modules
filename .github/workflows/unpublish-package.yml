name: ðŸ§¨ Unpublish package version

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Public package (packages/public/*)"
        required: true
        type: choice
        options:
          - ios-common-cookies
      version:
        description: "Version to unpublish (e.g. 1.0.1)"
        required: true

jobs:
  unpublish:
    name: Unpublish
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.FLOW_GITHUB_TOKEN }}

      - name: Enable Corepack
        run: corepack enable
        
      - name: Install dependencies
        run: yarn install --immutable --immutable-cache

      - name: Set npm token
        uses: "./.github/actions/set-npm-token"
        with:
          npm-token: ${{ secrets.NPM_PUBLISH_TOKEN }}

      - name: Unpublish npm package version
        env:
          NPM_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
        run: |
          PKG_JSON="packages/public/${{ github.event.inputs.package }}/package.json"
          PKG_NAME=$(node -p "require(process.argv[1]).name" "$PKG_JSON")
          echo "Unpublishing $PKG_NAME@${{ github.event.inputs.version }}"
          npm unpublish "$PKG_NAME@${{ github.event.inputs.version }}" --force
